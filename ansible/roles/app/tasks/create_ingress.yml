- name: Add NGINX Ingress Helm repository
  kubernetes.core.helm_repository:
    name: ingress-nginx
    repo_url: https://kubernetes.github.io/ingress-nginx

- name: Update Helm repositories
  command:
    cmd: helm repo update

- name: Install NGINX ingress controller
  kubernetes.core.helm:
    name: ingress-nginx
    chart_ref: ingress-nginx/ingress-nginx
    release_namespace: ingress-nginx
    create_namespace: yes
    values:
      controller:
        service:
          type: NodePort

- name: Wait for NGINX Ingress Controller to become available
  pause:
    seconds: 30

- name: Create Ingress for APP
  kubernetes.core.k8s:
    state: present
    namespace: "{{ app_namespace }}"
    definition:
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: "{{ app_name }}-ingress"
        namespace: "{{ app_namespace }}"
        annotations:
          kubernetes.io/ingress.class: "nginx"
      spec:
        rules:
        - http:
            paths:
            - path: "/"
              pathType: Prefix
              backend:
                service:
                  name: "{{ app_name }}-service"
                  port:
                    number: 3000


